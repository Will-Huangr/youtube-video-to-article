<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé¨ YouTubeËßÜÈ¢ëËΩ¨ÂõæÊñáÊñáÁ´†ÁîüÊàêÂô®</title>
    
    <!-- Á¨¨‰∏âÊñπÂ∫ì CDN -->
    <!-- Chart.js - ÂõæË°®Â±ïÁ§∫ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Marked.js - MarkdownËß£Êûê -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- DOMPurify - HTMLÂÆâÂÖ®Ê∏ÖÁêÜ -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    
    <!-- Highlight.js - ‰ª£Á†ÅÈ´ò‰∫Æ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Prism.js - Êõ¥Â•ΩÁöÑ‰ª£Á†ÅÈ´ò‰∫Æ -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <!-- MathJax - Êï∞Â≠¶ÂÖ¨Âºè -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .input-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .progress-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.5s ease;
        }

        .progress-text {
            text-align: center;
            font-weight: 600;
            color: #333;
        }

        .result-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            display: none;
        }

        .result-title {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 20px;
            color: #333;
        }

        .result-content {
            line-height: 1.6;
            color: #555;
        }

        /* ÂØåÊñáÊú¨ÂÜÖÂÆπÊ†∑Âºè */
        .rich-content {
            font-family: Georgia, serif;
            line-height: 1.8;
            color: #333;
            max-width: none;
        }

        .rich-content h1, .rich-content h2, .rich-content h3, .rich-content h4, .rich-content h5, .rich-content h6 {
            color: #2c3e50;
            margin-top: 30px;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .rich-content h1 { font-size: 2.2em; border-bottom: 3px solid #667eea; padding-bottom: 10px; }
        .rich-content h2 { font-size: 1.8em; border-bottom: 2px solid #667eea; padding-bottom: 8px; }
        .rich-content h3 { font-size: 1.5em; }
        .rich-content h4 { font-size: 1.3em; }

        .rich-content p {
            margin-bottom: 20px;
            text-align: justify;
            text-indent: 2em;
        }

        .rich-content ul, .rich-content ol {
            margin: 20px 0;
            padding-left: 30px;
        }

        .rich-content li {
            margin-bottom: 8px;
        }

        .rich-content blockquote {
            border-left: 4px solid #667eea;
            padding-left: 20px;
            margin: 20px 0;
            font-style: italic;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }

        .rich-content code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .rich-content pre {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 20px 0;
            border: 1px solid #e9ecef;
        }

        .rich-content pre code {
            background: none;
            padding: 0;
        }

        .rich-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
        }

        .rich-content th, .rich-content td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        .rich-content th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .rich-content tr:nth-child(even) {
            background: #f9f9f9;
        }

        .rich-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin: 20px 0;
        }

        .rich-content a {
            color: #667eea;
            text-decoration: none;
        }

        .rich-content a:hover {
            text-decoration: underline;
        }

        /* ÂõæË°®ÂÆπÂô®Ê†∑Âºè */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-title {
            text-align: center;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .image-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .image-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .feature-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .feature-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .feature-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .feature-desc {
            color: #666;
            line-height: 1.5;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        /* ÂÜÖÂÆπÊ†ºÂºèÈÄâÊã©Âô® */
        .format-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .format-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .format-btn.active {
            background: #667eea;
            color: white;
        }

        .format-btn:hover {
            background: #667eea;
            color: white;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .rich-content h1 { font-size: 1.8em; }
            .rich-content h2 { font-size: 1.5em; }
            .rich-content h3 { font-size: 1.3em; }
            .rich-content p { text-indent: 1em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé¨ YouTubeËßÜÈ¢ëËΩ¨ÂõæÊñáÊñáÁ´†ÁîüÊàêÂô®</h1>
            <p>Âü∫‰∫éAIÁöÑÊô∫ËÉΩÂÜÖÂÆπÂàõ‰ΩúÂ∑•ÂÖ∑ÔºåÂ∞ÜËßÜÈ¢ëËΩ¨Êç¢‰∏∫ÂõæÊñáÂπ∂ËåÇÁöÑÊñáÁ´†</p>
        </div>

        <div class="main-content">
            <!-- ËæìÂÖ•Âå∫Âüü -->
            <div class="input-section">
                <h2 style="margin-bottom: 20px; color: #333;">üìù ÂºÄÂßãÂàõ‰Ωú</h2>
                
                <div class="form-group">
                    <label for="video-url">üé• YouTubeËßÜÈ¢ëÈìæÊé•</label>
                    <input type="url" id="video-url" class="form-control" 
                           placeholder="ËØ∑ËæìÂÖ•YouTubeËßÜÈ¢ëÈìæÊé•Ôºå‰æãÂ¶ÇÔºöhttps://www.youtube.com/watch?v=...">
                </div>

                <div class="form-group">
                    <label for="language">üåê Â≠óÂπïËØ≠Ë®Ä</label>
                    <select id="language" class="form-control">
                        {% for code, name in languages.items() %}
                        <option value="{{ code }}" {% if code == 'en' %}selected{% endif %}>{{ name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="image-prompt">üé® ÈÖçÂõæÊèèËø∞ (ÂèØÈÄâ)</label>
                    <input type="text" id="image-prompt" class="form-control" 
                           placeholder="ÊèèËø∞‰Ω†ÊÉ≥Ë¶ÅÁöÑÈÖçÂõæÈ£éÊ†ºÔºå‰æãÂ¶ÇÔºöÁé∞‰ª£ÁßëÊäÄÈ£éÊ†º„ÄÅÊ∏©È¶®ÂÆ∂Â∫≠Âú∫ÊôØÁ≠â">
                </div>

                <button id="generate-btn" class="btn">üöÄ ÂºÄÂßãÁîüÊàê</button>
                
                <!-- DemoÊµãËØïÊåâÈíÆ -->
                <div style="margin-top: 15px; padding: 15px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #28a745;">
                    <h4 style="margin-bottom: 10px; color: #155724;">üß™ DifyÂ∑•‰ΩúÊµÅÊµãËØï (ÁªïËøáYouTubeÈôêÂà∂)</h4>
                    <p style="font-size: 14px; color: #155724; margin-bottom: 10px;">
                        <strong>ÁúüÂÆûDifyÂ∑•‰ΩúÊµÅË∞ÉÁî®ÊµãËØï</strong> - ‰ΩøÁî®test_document.txtÊñá‰ª∂Áõ¥Êé•Ë∞ÉÁî®Dify APIÔºåÈ™åËØÅÂ∑•‰ΩúÊµÅÂÆåÊï¥ÊÄß
                    </p>
                    <p style="font-size: 12px; color: #0d5a0f; margin-bottom: 15px;">
                        ‚ö†Ô∏è Ê≥®ÊÑèÔºöËøô‰∏™ÊåâÈíÆ‰ºöË∞ÉÁî®ÁúüÂÆûÁöÑDifyÂ∑•‰ΩúÊµÅÔºåÂèØËÉΩÈúÄË¶Å1-2ÂàÜÈíüÂ§ÑÁêÜÊó∂Èó¥
                    </p>
                    <button id="demo-test-btn" class="btn" style="background: #28a745; padding: 12px 25px; font-size: 16px;">
                        ü§ñ ÊµãËØïDifyÂ∑•‰ΩúÊµÅ
                    </button>
                </div>
            </div>

            <!-- ËøõÂ∫¶Âå∫Âüü -->
            <div id="progress-section" class="progress-section">
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill"></div>
                </div>
                <div id="progress-text" class="progress-text">ÂáÜÂ§á‰∏≠...</div>
            </div>

            <!-- ÁªìÊûúÂå∫Âüü -->
            <div id="result-section" class="result-section">
                <h2 class="result-title">‚ú® ÁîüÊàêÁªìÊûú</h2>
                
                <!-- Ê†ºÂºèÈÄâÊã©Âô® -->
                <div class="format-selector">
                    <button class="format-btn active" data-format="rich">üìù ÂØåÊñáÊú¨</button>
                    <button class="format-btn" data-format="html">üåê HTML</button>
                    <button class="format-btn" data-format="markdown">üìã Markdown</button>
                    <button class="format-btn" data-format="plain">üìÑ Á∫ØÊñáÊú¨</button>
                </div>
                
                <div id="result-content" class="result-content rich-content"></div>
                <div id="chart-container" class="chart-container" style="display: none;">
                    <div class="chart-title">üìä Êï∞ÊçÆÂèØËßÜÂåñ</div>
                    <canvas id="data-chart"></canvas>
                </div>
                <div id="image-gallery" class="image-gallery"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button id="copy-article-btn" class="btn">üìù Â§çÂà∂ÊñáÁ´†</button>
                    <button id="export-html-btn" class="btn">üíæ ÂØºÂá∫HTML</button>
                    <button id="generate-chart-btn" class="btn">üìä ÁîüÊàêÂõæË°®</button>
                </div>
            </div>

            <!-- ÂäüËÉΩÁâπËâ≤ -->
            <div class="features">
                <div class="feature-card">
                    <div class="feature-icon">üé•</div>
                    <div class="feature-title">ËßÜÈ¢ëÂÜÖÂÆπÊèêÂèñ</div>
                    <div class="feature-desc">Ëá™Âä®‰∏ãËΩΩYouTubeËßÜÈ¢ëÂ≠óÂπïÔºåÊîØÊåÅÂ§öÁßçËØ≠Ë®Ä</div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">ü§ñ</div>
                    <div class="feature-title">AIÊô∫ËÉΩÁîüÊàê</div>
                    <div class="feature-desc">ÈÄöËøáDifyÂ∑•‰ΩúÊµÅÁîüÊàêÈ´òË¥®ÈáèÊñáÁ´†ÂÜÖÂÆπ</div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üé®</div>
                    <div class="feature-title">Êô∫ËÉΩÈÖçÂõæ</div>
                    <div class="feature-desc">Âü∫‰∫éÊñáÁ´†‰∏ªÈ¢òËá™Âä®ÁîüÊàêÁõ∏ÂÖ≥ÈÖçÂõæ</div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üìù</div>
                    <div class="feature-title">ÂõæÊñáÁªìÂêà</div>
                    <div class="feature-desc">Êô∫ËÉΩÊéíÁâàÔºåÁîüÊàêÂõæÊñáÂπ∂ËåÇÁöÑÊúÄÁªàÊñáÁ´†</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Ëé∑ÂèñDOMÂÖÉÁ¥†
        const videoUrlInput = document.getElementById('video-url');
        const languageSelect = document.getElementById('language');
        const imagePromptInput = document.getElementById('image-prompt');
        const generateBtn = document.getElementById('generate-btn');
        // const testBtn = document.getElementById('test-btn'); // Â∑≤ÈöêËóèÊµãËØïÊåâÈíÆ
        const progressSection = document.getElementById('progress-section');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const resultSection = document.getElementById('result-section');
        const resultContent = document.getElementById('result-content');
        const imageGallery = document.getElementById('image-gallery');
        const copyArticleBtn = document.getElementById('copy-article-btn'); // Êñ∞Â¢ûÂ§çÂà∂ÊåâÈíÆ
        const formatSelector = document.querySelector('.format-selector');
        const formatButtons = formatSelector.querySelectorAll('.format-btn');
        const resultContentElement = document.getElementById('result-content');
        const chartContainer = document.getElementById('chart-container');
        const dataChartCanvas = document.getElementById('data-chart');
        const generateChartBtn = document.getElementById('generate-chart-btn');
        const exportHtmlBtn = document.getElementById('export-html-btn');
        
        // DemoÊåâÈíÆ
        const demoTestBtn = document.getElementById('demo-test-btn');

        // ÂÖ®Â±ÄÂèòÈáèÂ≠òÂÇ®ÂéüÂßãÊï∞ÊçÆ
        let originalContentData = {
            html: '',
            markdown: '',
            plainText: ''
        };

        // Ê†ºÂºèÈÄâÊã©Âô®ÁÇπÂáª‰∫ã‰ª∂
        formatSelector.addEventListener('click', (event) => {
            const target = event.target;
            if (target.classList.contains('format-btn')) {
                // ÁßªÈô§ÊâÄÊúâactiveÁä∂ÊÄÅ
                formatButtons.forEach(btn => btn.classList.remove('active'));
                // Ê∑ªÂä†activeÁä∂ÊÄÅÂà∞ÂΩìÂâçÊåâÈíÆ
                target.classList.add('active');
                
                // ÊâßË°åÊ†ºÂºèÂàáÊç¢
                const format = target.dataset.format;
                console.log('üîÑ ÂàáÊç¢Âà∞Ê†ºÂºè:', format);
                updateResultContentFormat(format);
            }
        });

        // Êõ¥Êñ∞ÁªìÊûúÂÜÖÂÆπÊ†ºÂºè - ÂÆåÂÖ®ÈáçÂÜô
        function updateResultContentFormat(format) {
            console.log('üìù Ê†ºÂºèÂàáÊç¢Âà∞:', format);
            
            if (!originalContentData.html) {
                console.warn('‚ö†Ô∏è Ê≤°ÊúâÂéüÂßãÊï∞ÊçÆÔºåÊó†Ê≥ïÂàáÊç¢Ê†ºÂºè');
                return;
            }
            
            const container = resultContentElement;
            
            switch (format) {
                case 'rich':
                    // ÂØåÊñáÊú¨Ê†ºÂºè - ÊòæÁ§∫Ê∏≤ÊüìÂêéÁöÑHTML
                    container.className = 'result-content rich-content';
                    container.innerHTML = originalContentData.html;
                    
                    // ÈáçÊñ∞ËøêË°å‰ª£Á†ÅÈ´ò‰∫ÆÂíåMathJax
                    if (typeof Prism !== 'undefined') {
                        Prism.highlightAll();
                    }
                    if (typeof MathJax !== 'undefined') {
                        MathJax.typesetPromise([container]).catch(console.error);
                    }
                    break;
                    
                case 'html':
                    // HTMLÊ†ºÂºè - ÊòæÁ§∫Ê∫ê‰ª£Á†Å
                    container.className = 'result-content';
                    const escapedHtml = originalContentData.html
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#39;');
                    
                    container.innerHTML = `<pre><code class="language-html">${escapedHtml}</code></pre>`;
                    
                    // ‰ª£Á†ÅÈ´ò‰∫Æ
                    if (typeof Prism !== 'undefined') {
                        Prism.highlightAll();
                    }
                    break;
                    
                case 'markdown':
                    // MarkdownÊ†ºÂºè - ÊòæÁ§∫markdownÊ∫êÁ†Å
                    container.className = 'result-content';
                    const markdownText = originalContentData.markdown || convertHtmlToMarkdown(originalContentData.html);
                    
                    container.innerHTML = `<pre><code class="language-markdown">${markdownText}</code></pre>`;
                    
                    // ‰ª£Á†ÅÈ´ò‰∫Æ
                    if (typeof Prism !== 'undefined') {
                        Prism.highlightAll();
                    }
                    break;
                    
                case 'plain':
                    // Á∫ØÊñáÊú¨Ê†ºÂºè - Âè™ÊòæÁ§∫ÊñáÊú¨ÂÜÖÂÆπ
                    container.className = 'result-content';
                    const plainText = originalContentData.plainText || extractPlainText(originalContentData.html);
                    
                    container.innerHTML = `<pre style="white-space: pre-wrap; font-family: inherit; background: #f8f9fa; padding: 20px; border-radius: 8px; line-height: 1.6; color: #333;">${plainText}</pre>`;
                    break;
                    
                default:
                    console.warn('‚ö†Ô∏è Êú™Áü•Ê†ºÂºè:', format);
                    break;
            }
            
            console.log('‚úÖ Ê†ºÂºèÂàáÊç¢ÂÆåÊàê:', format);
        }

        // Â∞ÜHTMLËΩ¨Êç¢‰∏∫Markdown - ÊîπËøõÁâà
        function convertHtmlToMarkdown(html) {
            let markdown = html;
            
            // ËΩ¨Êç¢Ê†áÈ¢ò
            markdown = markdown.replace(/<h1[^>]*>(.*?)<\/h1>/gi, '# $1\n\n');
            markdown = markdown.replace(/<h2[^>]*>(.*?)<\/h2>/gi, '## $1\n\n');
            markdown = markdown.replace(/<h3[^>]*>(.*?)<\/h3>/gi, '### $1\n\n');
            markdown = markdown.replace(/<h4[^>]*>(.*?)<\/h4>/gi, '#### $1\n\n');
            markdown = markdown.replace(/<h5[^>]*>(.*?)<\/h5>/gi, '##### $1\n\n');
            markdown = markdown.replace(/<h6[^>]*>(.*?)<\/h6>/gi, '###### $1\n\n');
            
            // ËΩ¨Êç¢ÊÆµËêΩ
            markdown = markdown.replace(/<p[^>]*>(.*?)<\/p>/gi, '$1\n\n');
            
            // ËΩ¨Êç¢Á≤ó‰ΩìÂíåÊñú‰Ωì
            markdown = markdown.replace(/<strong[^>]*>(.*?)<\/strong>/gi, '**$1**');
            markdown = markdown.replace(/<b[^>]*>(.*?)<\/b>/gi, '**$1**');
            markdown = markdown.replace(/<em[^>]*>(.*?)<\/em>/gi, '*$1*');
            markdown = markdown.replace(/<i[^>]*>(.*?)<\/i>/gi, '*$1*');
            
            // ËΩ¨Êç¢ÈìæÊé•
            markdown = markdown.replace(/<a[^>]*href="([^"]*)"[^>]*>(.*?)<\/a>/gi, '[$2]($1)');
            
            // ËΩ¨Êç¢ÂõæÁâá
            markdown = markdown.replace(/<img[^>]*src="([^"]*)"[^>]*alt="([^"]*)"[^>]*\/?>/gi, '![$2]($1)');
            
            // ËΩ¨Êç¢ÂàóË°®
            markdown = markdown.replace(/<ul[^>]*>(.*?)<\/ul>/gis, (match, content) => {
                return content.replace(/<li[^>]*>(.*?)<\/li>/gi, '- $1\n') + '\n';
            });
            
            markdown = markdown.replace(/<ol[^>]*>(.*?)<\/ol>/gis, (match, content) => {
                let counter = 1;
                return content.replace(/<li[^>]*>(.*?)<\/li>/gi, () => `${counter++}. $1\n`) + '\n';
            });
            
            // ËΩ¨Êç¢‰ª£Á†ÅÂùó
            markdown = markdown.replace(/<pre[^>]*><code[^>]*>(.*?)<\/code><\/pre>/gis, '```\n$1\n```\n\n');
            markdown = markdown.replace(/<code[^>]*>(.*?)<\/code>/gi, '`$1`');
            
            // ËΩ¨Êç¢ÂºïÁî®
            markdown = markdown.replace(/<blockquote[^>]*>(.*?)<\/blockquote>/gis, '> $1\n\n');
            
            // ËΩ¨Êç¢Ê∞¥Âπ≥Á∫ø
            markdown = markdown.replace(/<hr[^>]*\/?>/gi, '---\n\n');
            
            // ËΩ¨Êç¢Êç¢Ë°å
            markdown = markdown.replace(/<br[^>]*\/?>/gi, '\n');
            
            // Ê∏ÖÁêÜHTMLÊ†áÁ≠æ
            markdown = markdown.replace(/<[^>]*>/g, '');
            
            // Ê∏ÖÁêÜÂ§ö‰ΩôÁöÑÁ©∫Ë°å
            markdown = markdown.replace(/\n\s*\n\s*\n/g, '\n\n');
            
            // Ê∏ÖÁêÜHTMLÂÆû‰Ωì
            markdown = markdown.replace(/&nbsp;/g, ' ');
            markdown = markdown.replace(/&amp;/g, '&');
            markdown = markdown.replace(/&lt;/g, '<');
            markdown = markdown.replace(/&gt;/g, '>');
            markdown = markdown.replace(/&quot;/g, '"');
            markdown = markdown.replace(/&#39;/g, "'");
            
            return markdown.trim();
        }

        // ÊèêÂèñÁ∫ØÊñáÊú¨ÂÜÖÂÆπ
        function extractPlainText(html) {
            // ÂàõÂª∫‰∏¥Êó∂DOMÂÖÉÁ¥†
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            // ÊèêÂèñÁ∫ØÊñáÊú¨
            let plainText = tempDiv.textContent || tempDiv.innerText || '';
            
            // Ê∏ÖÁêÜÂ§ö‰ΩôÁöÑÁ©∫ÁôΩ
            plainText = plainText.replace(/\s+/g, ' ').trim();
            
            // ÊåâÂè•Â≠êÂàÜË°åÔºåÊîπÂñÑÂèØËØªÊÄß
            plainText = plainText.replace(/\. /g, '.\n');
            plainText = plainText.replace(/\? /g, '?\n');
            plainText = plainText.replace(/! /g, '!\n');
            
            return plainText;
        }

        // DemoÊåâÈíÆ‰∫ã‰ª∂Â§ÑÁêÜ
        async function handleDemo() {
            startProcessing();
            
            try {
                updateProgress(30, 'ÁîüÊàêDifyÂ∑•‰ΩúÊµÅÁ§∫‰æã...');
                
                const response = await fetch('/api/demo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        language: languageSelect.value,
                        picture_style: imagePromptInput.value || 'modern professional style'
                    })
                });

                if (!response.ok) {
                    throw new Error(`DemoËØ∑Ê±ÇÂ§±Ë¥•: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    updateProgress(100, 'Á§∫‰æãÁîüÊàêÂÆåÊàêÔºÅ');
                    showResult(result);
                    showAlert('DifyÂ∑•‰ΩúÊµÅÁ§∫‰æãÁîüÊàêÊàêÂäüÔºÅÁé∞Âú®ÂèØ‰ª•ÊµãËØïÊ†ºÂºèÂàáÊç¢ÂäüËÉΩ„ÄÇ', 'success');
                } else {
                    throw new Error(result.message || 'DemoÁîüÊàêÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('DemoÁîüÊàêÂ§±Ë¥•:', error);
                showAlert('DemoÁîüÊàêÂ§±Ë¥•: ' + error.message, 'error');
            } finally {
                stopProcessing();
            }
        }

        // DemoÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
        demoTestBtn.addEventListener('click', handleDemo);

        // ÁîüÊàêÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
        generateBtn.addEventListener('click', async () => {
            const videoUrl = videoUrlInput.value.trim();
            const language = languageSelect.value;
            const imagePrompt = imagePromptInput.value.trim();

            if (!videoUrl) {
                showAlert('ËØ∑ËæìÂÖ•YouTubeËßÜÈ¢ëÈìæÊé•', 'error');
                return;
            }

            if (!isValidYouTubeUrl(videoUrl)) {
                showAlert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑYouTubeËßÜÈ¢ëÈìæÊé•', 'error');
                return;
            }

            // ÂºÄÂßãÂ§ÑÁêÜ
            startProcessing();

            try {
                // Â§ÑÁêÜËßÜÈ¢ë
                const result = await processVideo(videoUrl, language, imagePrompt);
                
                if (result.success) {
                    // Â¶ÇÊûúÊúâÈÖçÂõæÊèèËø∞ÔºåÁîüÊàêÈÖçÂõæ
                    if (imagePrompt) {
                        updateProgress(80, 'ÁîüÊàêÈÖçÂõæ‰∏≠...');
                        await generateImages(imagePrompt);
                    }
                    
                    // ÊòæÁ§∫ÁªìÊûú
                    showResult(result);
                    showAlert('ÊñáÁ´†ÁîüÊàêÊàêÂäüÔºÅ', 'success');
                } else {
                    throw new Error(result.message || 'Â§ÑÁêÜÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('Â§ÑÁêÜÂ§±Ë¥•:', error);
                showAlert('Â§ÑÁêÜÂ§±Ë¥•: ' + error.message, 'error');
            } finally {
                stopProcessing();
            }
        });

        // Â§çÂà∂ÊñáÁ´†ÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
        copyArticleBtn.addEventListener('click', () => {
            try {
                // Ëé∑ÂèñÊñáÁ´†ÂÜÖÂÆπ
                const titleElement = resultContentElement.querySelector('h3');
                const contentElement = resultContentElement.querySelector('p');
                const title = titleElement ? titleElement.textContent : '';
                const content = contentElement ? contentElement.textContent : '';
                
                // Ëé∑ÂèñÂõæÁâá‰ø°ÊÅØ
                const imageItems = imageGallery.querySelectorAll('.image-item');
                let imagesText = '';
                
                if (imageItems.length > 0) {
                    imagesText = '\n\nüì∏ ÈÖçÂõæ‰ø°ÊÅØ:\n';
                    imageItems.forEach((item, index) => {
                        const img = item.querySelector('img');
                        const desc = item.querySelector('p');
                        if (img && desc) {
                            imagesText += `${index + 1}. ${desc.textContent}\n   ÂõæÁâáÈìæÊé•: ${img.src}\n\n`;
                        }
                    });
                }
                
                // ÁªÑÂêàÂÆåÊï¥ÊñáÁ´†ÂÜÖÂÆπ
                const fullArticle = `${title}\n\n${content}${imagesText}`;
                
                // Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø
                navigator.clipboard.writeText(fullArticle).then(() => {
                    showAlert('ÊñáÁ´†ÂÜÖÂÆπÔºàÂåÖÂê´ÂõæÁâá‰ø°ÊÅØÔºâÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ', 'success');
                }).catch(err => {
                    console.error('Â§çÂà∂Â§±Ë¥•:', err);
                    // ÈôçÁ∫ßÊñπÊ°àÔºöÂàõÂª∫‰∏¥Êó∂ÊñáÊú¨Âå∫Âüü
                    const textArea = document.createElement('textarea');
                    textArea.value = fullArticle;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showAlert('ÊñáÁ´†Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ', 'success');
                });
                
            } catch (error) {
                console.error('Â§çÂà∂Êìç‰ΩúÂ§±Ë¥•:', error);
                showAlert('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂', 'error');
            }
        });

        // ÂØºÂá∫HTMLÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
        exportHtmlBtn.addEventListener('click', () => {
            const htmlContent = resultContentElement.innerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'article.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showAlert('ÊñáÁ´†Â∑≤ÂØºÂá∫‰∏∫ article.html', 'success');
        });

        // ÁîüÊàêÂõæË°®ÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
        generateChartBtn.addEventListener('click', async () => {
            const data = JSON.parse(resultContentElement.dataset.chartData || '{}');
            if (Object.keys(data).length === 0) {
                showAlert('Ê≤°ÊúâÂèØÁî®ÁöÑÂõæË°®Êï∞ÊçÆ', 'error');
                return;
            }

            updateProgress(80, 'ÁîüÊàêÂõæË°®‰∏≠...');
            try {
                const chartData = await generateChart(data);
                if (chartData.success) {
                    chartContainer.style.display = 'block';
                    const ctx = dataChartCanvas.getContext('2d');
                    new Chart(ctx, {
                        type: 'bar', // Á§∫‰æãÁ±ªÂûãÔºåÂèØÊ†πÊçÆÈúÄË¶ÅÊõ¥Êîπ
                        data: chartData.data,
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: chartData.title || 'Êï∞ÊçÆÂèØËßÜÂåñÂõæË°®'
                                },
                                legend: {
                                    position: 'top',
                                }
                            }
                        }
                    });
                    showAlert('ÂõæË°®ÁîüÊàêÊàêÂäüÔºÅ', 'success');
                } else {
                    throw new Error(chartData.message || 'ÂõæË°®ÁîüÊàêÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('ÂõæË°®ÁîüÊàêÂ§±Ë¥•:', error);
                showAlert('ÂõæË°®ÁîüÊàêÂ§±Ë¥•: ' + error.message, 'error');
            } finally {
                updateProgress(0, 'ÂáÜÂ§á‰∏≠...');
            }
        });

        // ÂºÄÂßãÂ§ÑÁêÜ
        function startProcessing() {
            generateBtn.disabled = true;
            generateBtn.textContent = 'Â§ÑÁêÜ‰∏≠...';
            progressSection.style.display = 'block';
            resultSection.style.display = 'none';
            
            // Ê®°ÊãüËøõÂ∫¶
            updateProgress(20, 'Ëß£ÊûêËßÜÈ¢ë‰ø°ÊÅØ...');
            setTimeout(() => updateProgress(40, 'ÊèêÂèñÂ≠óÂπïÂÜÖÂÆπ...'), 1000);
            setTimeout(() => updateProgress(60, 'AIÁîüÊàêÊñáÁ´†...'), 2000);
        }

        // ÂÅúÊ≠¢Â§ÑÁêÜ
        function stopProcessing() {
            generateBtn.disabled = false;
            generateBtn.textContent = 'üöÄ ÂºÄÂßãÁîüÊàê';
            progressSection.style.display = 'none';
            updateProgress(0, 'ÂáÜÂ§á‰∏≠...');
        }

        // Êõ¥Êñ∞ËøõÂ∫¶
        function updateProgress(percent, text) {
            progressFill.style.width = percent + '%';
            progressText.textContent = text;
        }

        // Â§ÑÁêÜËßÜÈ¢ë
        async function processVideo(videoUrl, language, pictureStyle) {
            try {
                console.log('ÂèëÈÄÅËØ∑Ê±ÇÂà∞:', '/api/process-video');
                console.log('ËØ∑Ê±ÇÊï∞ÊçÆ:', { video_url: videoUrl, language: language, picture_style: pictureStyle });
                
                const response = await fetch('/api/process-video', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        video_url: videoUrl,
                        language: language,
                        picture_style: pictureStyle  // ‰º†ÈÄíÈÖçÂõæÊèèËø∞
                    })
                });

                console.log('ÂìçÂ∫îÁä∂ÊÄÅ:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('APIÈîôËØØÂìçÂ∫î:', errorText);
                    throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                console.log('APIÂìçÂ∫î:', result);
                return result;
                
            } catch (error) {
                console.error('ÁΩëÁªúËØ∑Ê±ÇËØ¶ÁªÜÈîôËØØ:', error);
                throw error;
            }
        }

        // ÁîüÊàêÈÖçÂõæ
        async function generateImages(prompt) {
            try {
                const response = await fetch('/api/generate-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: prompt
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('ÈÖçÂõæÁîüÊàêÁªìÊûú:', result);
                }
            } catch (error) {
                console.error('ÈÖçÂõæÁîüÊàêÂ§±Ë¥•:', error);
            }
        }

        // ÁîüÊàêÂõæË°® (Á§∫‰æãÔºåÂÆûÈôÖÈúÄË¶ÅÂêéÁ´ØÊèê‰æõÊï∞ÊçÆ)
        async function generateChart(data) {
            // Ê®°ÊãüÁîüÊàêÂõæË°®Êï∞ÊçÆ
            const chartData = {
                labels: Object.keys(data),
                datasets: [{
                    label: 'Êï∞ÊçÆ',
                    data: Object.values(data),
                    backgroundColor: 'rgba(102, 126, 234, 0.6)',
                    borderColor: 'rgba(102, 126, 234, 1)',
                    borderWidth: 1
                }]
            };
            const chartTitle = 'Êï∞ÊçÆÂèØËßÜÂåñÂõæË°®';
            return { success: true, data: chartData, title: chartTitle };
        }

        // ÊòæÁ§∫ÁªìÊûú
        function showResult(apiResponse) {
            console.log('ÊòæÁ§∫ÁªìÊûúÔºåAPIÂìçÂ∫î:', apiResponse);
            
            // Ê≠£Á°ÆËÆøÈóÆÊï∞ÊçÆÁªìÊûÑ
            const data = apiResponse.data || apiResponse;
            
            // ÂÆâÂÖ®Âú∞Ëé∑ÂèñÊï∞ÊçÆÔºåÊèê‰æõÈªòËÆ§ÂÄº
            const title = data.title || 'Êú™Áü•Ê†áÈ¢ò';
            const content = data.content || 'ÂÜÖÂÆπÁîüÊàêÂ§±Ë¥•';
            const videoInfo = data.video_info || {};
            const images = data.images || [];
            
            console.log('ÂéüÂßãÂÜÖÂÆπ:', content);
            console.log('ÂÜÖÂÆπÈïøÂ∫¶:', content.length);
            
            // Êô∫ËÉΩÊ†ºÂºèÂåñÂÜÖÂÆπ
            let processedContent = smartFormatContent(content);
            
            // ÊûÑÂª∫‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü
            const mainContentHtml = `
                <div class="rich-content">
                    <h1>${title}</h1>
                    <div style="margin-top: 20px;">${processedContent}</div>
                </div>
            `;
            
            // ÊûÑÂª∫ÂÆåÊï¥ÁªìÊûúÂÜÖÂÆπ
            let resultHtml = mainContentHtml;
            
            // Ê∑ªÂä†ËßÜÈ¢ë‰ø°ÊÅØ
            resultHtml += `
                <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                    <h3>üìπ ËßÜÈ¢ë‰ø°ÊÅØ</h3>
                    <p><strong>ÈìæÊé•:</strong> <a href="${videoInfo.url || '#'}" target="_blank">${videoInfo.url || 'Êú™Áü•'}</a></p>
                    <p><strong>ËØ≠Ë®Ä:</strong> ${videoInfo.language || 'Êú™Áü•'}</p>
                    <p><strong>ÈÖçÂõæÈ£éÊ†º:</strong> ${videoInfo.picture_style || 'Êú™ËÆæÁΩÆ'}</p>
                    <p><strong>Êó∂Èïø:</strong> ${videoInfo.duration || 'Êú™Áü•'}</p>
                </div>
            `;
            
            // Ê∑ªÂä†Â§ÑÁêÜ‰ø°ÊÅØ
            if (apiResponse.message) {
                resultHtml += `
                    <div style="margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <h4>‚ÑπÔ∏è Â§ÑÁêÜ‰ø°ÊÅØ</h4>
                        <p>${apiResponse.message}</p>
                    </div>
                `;
            }
            
            // Ê∑ªÂä†Ë∞ÉËØï‰ø°ÊÅØ
            resultHtml += `
                <details style="margin-top: 20px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #667eea;">üîç Ë∞ÉËØï‰ø°ÊÅØ (ÁÇπÂáªÂ±ïÂºÄ)</summary>
                    <pre style="background: #f5f5f5; padding: 15px; border-radius: 5px; font-size: 12px; max-height: 300px; overflow-y: auto; margin-top: 10px;">${JSON.stringify(apiResponse, null, 2)}</pre>
                </details>
            `;
            
            // üî• Â≠òÂÇ®ÂéüÂßãÊï∞ÊçÆ - ËøôÊòØÂÖ≥ÈîÆÔºÅ
            originalContentData.html = resultHtml;
            originalContentData.markdown = convertHtmlToMarkdown(mainContentHtml);
            originalContentData.plainText = extractPlainText(mainContentHtml);
            
            console.log('üíæ ÂéüÂßãÊï∞ÊçÆÂ∑≤Â≠òÂÇ®:', {
                htmlLength: originalContentData.html.length,
                markdownLength: originalContentData.markdown.length,
                plainTextLength: originalContentData.plainText.length
            });
            
            // ÊòæÁ§∫ÂÜÖÂÆπ
            resultContentElement.innerHTML = resultHtml;
            
            // ÈáçÁΩÆÊ†ºÂºèÈÄâÊã©Âô®Âà∞ÂØåÊñáÊú¨
            formatButtons.forEach(btn => btn.classList.remove('active'));
            const richBtn = document.querySelector('.format-btn[data-format="rich"]');
            if (richBtn) richBtn.classList.add('active');
            
            // Â≠òÂÇ®ÂõæË°®Êï∞ÊçÆ
            resultContentElement.dataset.chartData = JSON.stringify(data.chart_data || {});
            
            // ÈáçÊñ∞ËøêË°å‰ª£Á†ÅÈ´ò‰∫ÆÂíåMathJax
            if (typeof Prism !== 'undefined') {
                Prism.highlightAll();
            }
            if (typeof MathJax !== 'undefined') {
                MathJax.typesetPromise([resultContentElement]).then(() => {
                    console.log('MathJaxÊ∏≤ÊüìÂÆåÊàê');
                }).catch((err) => console.log('MathJaxÊ∏≤ÊüìÂ§±Ë¥•:', err));
            }

            // ÊòæÁ§∫ÈÖçÂõæ
            if (images && images.length > 0) {
                imageGallery.innerHTML = images.map(img => `
                    <div class="image-item">
                        <img src="${img.url || ''}" alt="${img.description || 'ÈÖçÂõæ'}" onerror="this.style.display='none'">
                        <p>${img.description || 'ÈÖçÂõæÊèèËø∞'}</p>
                    </div>
                `).join('');
            } else {
                imageGallery.innerHTML = '<p style="text-align: center; color: #666;">ÊöÇÊó†ÈÖçÂõæ</p>';
            }

            resultSection.style.display = 'block';
            
            console.log('‚úÖ ÁªìÊûúÊòæÁ§∫ÂÆåÊàêÔºåÊ†ºÂºèÂàáÊç¢Â∑≤ÂáÜÂ§áÂ∞±Áª™');
        }

        // Êô∫ËÉΩÊ†ºÂºèÂåñÂÜÖÂÆπ - ÂÆåÂÖ®ÈáçÂÜô
        function smartFormatContent(content) {
            console.log('üîß ÂºÄÂßãmarkdownËß£ÊûêÔºåÂéüÂßãÂÜÖÂÆπ:', content);
            
            // Â¶ÇÊûúÂÜÖÂÆπ‰∏∫Á©∫ÊàñÊó†ÊïàÔºåËøîÂõûÈîôËØØ‰ø°ÊÅØ
            if (!content || typeof content !== 'string') {
                return '<p style="color: #999; font-style: italic;">ÂÜÖÂÆπ‰∏∫Á©∫ÊàñÊ†ºÂºèÈîôËØØ</p>';
            }

            // È¢ÑÂ§ÑÁêÜÔºöÊ∏ÖÁêÜÂíåÊ†áÂáÜÂåñÂÜÖÂÆπ
            let processedContent = content.trim();
            
            // üöÄ Âº∫Âà∂‰ΩøÁî®marked.jsËøõË°åmarkdownÊ∏≤Êüì
            try {
                // Á°Æ‰øùmarkedÂ∑≤Âä†ËΩΩ
                if (typeof marked !== 'undefined') {
                    console.log('‚úÖ ‰ΩøÁî®Marked.jsÂº∫Âà∂Ê∏≤ÊüìMarkdown');
                    
                    // ÈÖçÁΩÆmarkedÈÄâÈ°π - Êõ¥ÂÆåÊï¥ÁöÑÈÖçÁΩÆ
                    marked.setOptions({
                        breaks: true,           // ÊîØÊåÅÊç¢Ë°åÁ¨¶
                        gfm: true,             // GitHubÈ£éÊ†ºmarkdown
                        sanitize: false,       // ‰∏çËøáÂ∫¶Ê∏ÖÁêÜHTML
                        smartypants: false,    // ‰∏çËΩ¨Êç¢ÂºïÂè∑
                        headerIds: false,      // ‰∏çÁîüÊàêheader id
                        mangle: false,         // ‰∏çÊ∑∑Ê∑ÜÈìæÊé•
                        pedantic: false,       // ‰∏ç‰∏•Ê†ºÊ®°Âºè
                        smartLists: true,      // Êô∫ËÉΩÂàóË°®
                        xhtml: false          // ‰∏ç‰ΩøÁî®XHTML
                    });
                    
                    // üî• Áõ¥Êé•Âº∫Âà∂Ëß£ÊûêmarkdownÔºå‰∏çÁÆ°Ê£ÄÊµãÁªìÊûú
                    const renderedHtml = marked.parse(processedContent);
                    console.log('üéØ MarkdownÊ∏≤ÊüìÁªìÊûú:', renderedHtml);
                    
                    return renderedHtml;
                    
                } else {
                    console.error('‚ùå Marked.jsÊú™Âä†ËΩΩÔºå‰ΩøÁî®Â§áÈÄâÊ∏≤Êüì');
                    return renderMarkdownFallback(processedContent);
                }
                
            } catch (error) {
                console.error('‚ùå Marked.jsÊ∏≤ÊüìÂ§±Ë¥•:', error);
                return renderMarkdownFallback(processedContent);
            }
        }
        
        // Â§áÈÄâmarkdownÊ∏≤ÊüìÂáΩÊï∞
        function renderMarkdownFallback(content) {
            console.log('üîß ‰ΩøÁî®Â§áÈÄâmarkdownÊ∏≤ÊüìÂô®');
            
            let html = content;
            
            // Â§ÑÁêÜÊç¢Ë°åÁ¨¶
            html = html.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            
            // Â§ÑÁêÜÊ†áÈ¢ò (# ## ### #### ##### ######)
            html = html.replace(/^######\s+(.+)$/gm, '<h6>$1</h6>');
            html = html.replace(/^#####\s+(.+)$/gm, '<h5>$1</h5>');
            html = html.replace(/^####\s+(.+)$/gm, '<h4>$1</h4>');
            html = html.replace(/^###\s+(.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^##\s+(.+)$/gm, '<h2>$1</h2>');
            html = html.replace(/^#\s+(.+)$/gm, '<h1>$1</h1>');
            
            // Â§ÑÁêÜÁ≤ó‰Ωì **text**
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // Â§ÑÁêÜÊñú‰Ωì *text*
            html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            
            // Â§ÑÁêÜË°åÂÜÖ‰ª£Á†Å `code`
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Â§ÑÁêÜ‰ª£Á†ÅÂùó ```code```
            html = html.replace(/```([^`]*)```/gs, '<pre><code>$1</code></pre>');
            
            // Â§ÑÁêÜÈìæÊé• [text](url)
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            
            // Â§ÑÁêÜÊó†Â∫èÂàóË°®
            html = html.replace(/^[-*+]\s+(.+)$/gm, '<li>$1</li>');
            
            // Â§ÑÁêÜÊúâÂ∫èÂàóË°®
            html = html.replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>');
            
            // ÂåÖË£ÖËøûÁª≠ÁöÑli‰∏∫ul/ol
            html = html.replace(/(<li>.*<\/li>)/s, function(match) {
                return '<ul>' + match + '</ul>';
            });
            
            // Â§ÑÁêÜÂºïÁî® > text
            html = html.replace(/^>\s*(.+)$/gm, '<blockquote>$1</blockquote>');
            
            // Â§ÑÁêÜÂàÜÈöîÁ∫ø ---
            html = html.replace(/^---+$/gm, '<hr>');
            
            // Â§ÑÁêÜÊÆµËêΩ - ÂèåÊç¢Ë°åÁ¨¶ÂàÜÈöî
            const paragraphs = html.split(/\n\s*\n/);
            html = paragraphs.map(p => {
                p = p.trim();
                if (!p) return '';
                
                // Â¶ÇÊûúÂ∑≤ÁªèÊòØHTMLÊ†áÁ≠æÔºåÁõ¥Êé•ËøîÂõû
                if (/^<(h[1-6]|ul|ol|li|blockquote|pre|hr)/.test(p)) {
                    return p;
                }
                
                // Âê¶ÂàôÂåÖË£Ö‰∏∫ÊÆµËêΩ
                return `<p>${p}</p>`;
            }).filter(p => p).join('\n');
            
            // Â§ÑÁêÜÂçï‰∏™Êç¢Ë°åÁ¨¶‰∏∫<br>
            html = html.replace(/\n/g, '<br>');
            
            console.log('üéØ Â§áÈÄâÊ∏≤ÊüìÁªìÊûú:', html);
            return html;
        }

        // Ê£ÄÊµãÂÜÖÂÆπÊ†ºÂºèÁ±ªÂûã
        function detectContentFormat(content) {
            // Ê£ÄÊµãHTMLÊ†áÁ≠æ
            if (/<[^>]*>/.test(content) && !content.includes('#') && !content.includes('**')) {
                return 'html';
            }
            
            // Ê£ÄÊµãMarkdownËØ≠Ê≥ïÔºàÊõ¥‰∏•Ê†ºÁöÑÊ£ÄÊµãÔºâ
            const markdownPatterns = [
                /^#{1,6}\s+.+$/m,      // Ê†áÈ¢ò
                /\*\*[^*]+\*\*/,       // Á≤ó‰Ωì
                /\*[^*]+\*/,           // Êñú‰Ωì
                /^\s*[-*+]\s+/m,       // ÂàóË°®
                /^\s*\d+\.\s+/m,       // Êï∞Â≠óÂàóË°®
                /```[\s\S]*?```/,      // ‰ª£Á†ÅÂùó
                /`[^`]+`/,             // Ë°åÂÜÖ‰ª£Á†Å
                /\[[^\]]*\]\([^)]*\)/, // ÈìæÊé•
                /^\s*>/m,              // ÂºïÁî®
                /#{2,}\s+/,            // ## Ê†áÈ¢ò
                /\*\*[^*]+\*\*/g       // Á≤ó‰ΩìÊñáÊú¨
            ];
            
            // Â¶ÇÊûúÂåÖÂê´Â§ö‰∏™markdownÁâπÂæÅÔºåÁ°ÆÂÆö‰∏∫markdown
            const markdownMatches = markdownPatterns.filter(pattern => pattern.test(content));
            if (markdownMatches.length >= 2 || content.includes('# ') || content.includes('## ')) {
                return 'markdown';
            }
            
            // Ê£ÄÊµãÁªìÊûÑÂåñÊñáÊú¨ÔºàÂåÖÂê´Â∏∏ËßÅÁöÑÊ†ºÂºèÂåñÊ†áËÆ∞Ôºâ
            const structuredPatterns = [
                /^[#*]{2,}/m,          // ‰ª•##Êàñ**ÂºÄÂ§¥
                /\*\*[^*]+\*\*/,       // Á≤ó‰ΩìÊ†áËÆ∞
                /##\s+[^#]+/,          // Ê†áÈ¢òÊ†áËÆ∞
                /^\s*[-‚Ä¢]\s+/m,        // ÂàóË°®È°π
                /^\s*\d+\.\s+/m,       // Êï∞Â≠óÂàóË°®
                /Introduction|Step \d+|Conclusion/i // Â∏∏ËßÅÁöÑÁªìÊûÑÂåñÊñáÊú¨Ê†áËÆ∞
            ];
            
            if (structuredPatterns.some(pattern => pattern.test(content))) {
                return 'structured-text';
            }
            
            return 'plain';
        }

        // Ê†ºÂºèÂåñÁªìÊûÑÂåñÊñáÊú¨
        function formatStructuredText(content) {
            console.log('Ê†ºÂºèÂåñÁªìÊûÑÂåñÊñáÊú¨');
            
            let formatted = content;
            
            // ËΩ¨Êç¢Ê†áÈ¢òÊ†áËÆ∞
            formatted = formatted.replace(/^## ([^#\n]+)/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^### ([^#\n]+)/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^#### ([^#\n]+)/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^# ([^#\n]+)/gm, '<h1>$1</h1>');
            
            // ËΩ¨Êç¢Á≤ó‰Ωì
            formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // ËΩ¨Êç¢Êñú‰Ωì
            formatted = formatted.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            
            // ËΩ¨Êç¢ÂàóË°®È°π
            formatted = formatted.replace(/^[-‚Ä¢]\s+(.+)$/gm, '<li>$1</li>');
            formatted = formatted.replace(/^(\s*)\d+\.\s+(.+)$/gm, '<li>$2</li>');
            
            // ÂåÖË£ÖËøûÁª≠ÁöÑliÊ†áÁ≠æ‰∏∫ul - ‰øÆÂ§çÁâàÊú¨
            const lines = formatted.split('\n');
            let result = [];
            let inList = false;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line.startsWith('<li>')) {
                    if (!inList) {
                        result.push('<ul>');
                        inList = true;
                    }
                    result.push(line);
                } else {
                    if (inList) {
                        result.push('</ul>');
                        inList = false;
                    }
                    if (line) {
                        result.push(line);
                    }
                }
            }
            
            // Â¶ÇÊûúÊúÄÂêéËøòÂú®ÂàóË°®‰∏≠ÔºåÂÖ≥Èó≠ÂàóË°®
            if (inList) {
                result.push('</ul>');
            }
            
            formatted = result.join('\n');
            
            // ËΩ¨Êç¢ÊÆµËêΩÔºàÂ∞ÜÂèåÊç¢Ë°åÁ¨¶ËΩ¨Êç¢‰∏∫ÊÆµËêΩÔºâ
            const paragraphs = formatted.split(/\n\s*\n/);
            formatted = paragraphs.map(p => {
                p = p.trim();
                if (!p) return '';
                
                // Â¶ÇÊûúÂ∑≤ÁªèÊòØHTMLÊ†áÁ≠æÔºåÁõ¥Êé•ËøîÂõû
                if (/<[^>]*>/.test(p)) {
                    return p;
                }
                
                // Âê¶ÂàôÂåÖË£Ö‰∏∫ÊÆµËêΩ
                return `<p>${p}</p>`;
            }).filter(p => p).join('\n\n');
            
            // Ê∏ÖÁêÜÂ§ö‰ΩôÁöÑÁ©∫Ë°å
            formatted = formatted.replace(/\n\s*\n\s*\n/g, '\n\n');
            
            console.log('Ê†ºÂºèÂåñÁªìÊûú:', formatted);
            return formatted;
        }

        // Ê†ºÂºèÂåñÁ∫ØÊñáÊú¨
        function formatPlainText(content) {
            console.log('Ê†ºÂºèÂåñÁ∫ØÊñáÊú¨');
            
            // Â∞ÜÊñáÊú¨ÂàÜÂâ≤‰∏∫ÊÆµËêΩ
            const paragraphs = content.split(/\n\s*\n/);
            
            return paragraphs.map(p => {
                p = p.trim();
                if (!p) return '';
                
                // Ëá™Âä®Ê£ÄÊµãÊ†áÈ¢òÔºàÈÄöÂ∏∏ÊØîËæÉÁü≠‰∏îÁã¨Á´ã‰∏ÄË°åÔºâ
                if (p.length < 100 && !p.includes('.') && !p.includes(',')) {
                    return `<h3>${p}</h3>`;
                }
                
                return `<p>${p}</p>`;
            }).filter(p => p).join('\n');
        }

        // ÊòæÁ§∫ÊèêÁ§∫‰ø°ÊÅØ
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const mainContent = document.querySelector('.main-content');
            mainContent.insertBefore(alertDiv, mainContent.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // È™åËØÅYouTubeÈìæÊé•
        function isValidYouTubeUrl(url) {
            const youtubeRegex = /^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.be)\/.+/;
            return youtubeRegex.test(url);
        }

        // MathJaxÈÖçÁΩÆ
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            }
        };

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÊ£ÄÊü•APIÁä∂ÊÄÅ
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/api/health');
                const health = await response.json();
                
                if (!health.config_valid) {
                    showAlert('ÈÖçÁΩÆÊú™ÂÆåÊàêÔºåËØ∑Ê£ÄÊü•config.pyÊñá‰ª∂‰∏≠ÁöÑAPIÂØÜÈí•ËÆæÁΩÆ', 'error');
                }
                
                // ÂàùÂßãÂåñMarkedÈÖçÁΩÆ
                if (typeof marked !== 'undefined') {
                    marked.setOptions({
                        highlight: function(code, lang) {
                            if (typeof Prism !== 'undefined' && Prism.languages[lang]) {
                                return Prism.highlight(code, Prism.languages[lang], lang);
                            }
                            return code;
                        },
                        breaks: true,
                        gfm: true,
                        sanitize: false,
                        smartypants: false
                    });
                    console.log('‚úÖ Marked.jsÈÖçÁΩÆÂÆåÊàê');
                } else {
                    console.warn('‚ö†Ô∏è Marked.jsÊú™Âä†ËΩΩ');
                }
                
            } catch (error) {
                console.error('ÂÅ•Â∫∑Ê£ÄÊü•Â§±Ë¥•:', error);
            }
        });
    </script>
</body>
</html> 