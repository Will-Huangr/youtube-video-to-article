<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¬ YouTubeè§†é¢‘è½¬å›¾æ–‡æ–‡ç« ç”Ÿæˆå™¨</title>
    
    <!-- ç¬¬ä¸‰æ–¹åº“ CDN -->
    <!-- Chart.js - å›¾è¡¨å±•ç¤º -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Marked.js - Markdownè§£æ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- DOMPurify - HTMLå®‰å…¨æ¸…ç† -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    
    <!-- Highlight.js - ä»£ç é«˜äº® -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Prism.js - æ›´å¥½çš„ä»£ç é«˜äº® -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <!-- MathJax - æ•°å­¦å…¬å¼ -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .input-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .progress-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.5s ease;
        }

        .progress-text {
            text-align: center;
            font-weight: 600;
            color: #333;
        }

        .result-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            display: none;
        }

        .result-title {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 20px;
            color: #333;
        }

        .result-content {
            line-height: 1.6;
            color: #555;
        }

        /* å¯Œæ–‡æœ¬å†…å®¹æ ·å¼ */
        .rich-content {
            font-family: Georgia, serif;
            line-height: 1.8;
            color: #333;
            max-width: none;
        }

        .rich-content h1, .rich-content h2, .rich-content h3, .rich-content h4, .rich-content h5, .rich-content h6 {
            color: #2c3e50;
            margin-top: 30px;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .rich-content h1 { font-size: 2.2em; border-bottom: 3px solid #667eea; padding-bottom: 10px; }
        .rich-content h2 { font-size: 1.8em; border-bottom: 2px solid #667eea; padding-bottom: 8px; }
        .rich-content h3 { font-size: 1.5em; }
        .rich-content h4 { font-size: 1.3em; }

        .rich-content p {
            margin-bottom: 20px;
            text-align: justify;
            text-indent: 2em;
        }

        .rich-content ul, .rich-content ol {
            margin: 20px 0;
            padding-left: 30px;
        }

        .rich-content li {
            margin-bottom: 8px;
        }

        .rich-content blockquote {
            border-left: 4px solid #667eea;
            padding-left: 20px;
            margin: 20px 0;
            font-style: italic;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }

        .rich-content code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .rich-content pre {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 20px 0;
            border: 1px solid #e9ecef;
        }

        .rich-content pre code {
            background: none;
            padding: 0;
        }

        .rich-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
        }

        .rich-content th, .rich-content td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        .rich-content th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .rich-content tr:nth-child(even) {
            background: #f9f9f9;
        }

        .rich-content img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin: 20px 0;
        }

        .rich-content a {
            color: #667eea;
            text-decoration: none;
        }

        .rich-content a:hover {
            text-decoration: underline;
        }

        /* å›¾è¡¨å®¹å™¨æ ·å¼ */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-title {
            text-align: center;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .image-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .image-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .feature-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .feature-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .feature-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .feature-desc {
            color: #666;
            line-height: 1.5;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        /* å†…å®¹æ ¼å¼é€‰æ‹©å™¨ */
        .format-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .format-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .format-btn.active {
            background: #667eea;
            color: white;
        }

        .format-btn:hover {
            background: #667eea;
            color: white;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .rich-content h1 { font-size: 1.8em; }
            .rich-content h2 { font-size: 1.5em; }
            .rich-content h3 { font-size: 1.3em; }
            .rich-content p { text-indent: 1em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¬ YouTubeè§†é¢‘è½¬å›¾æ–‡æ–‡ç« ç”Ÿæˆå™¨</h1>
            <p>åŸºäºAIçš„æ™ºèƒ½å†…å®¹åˆ›ä½œå·¥å…·ï¼Œå°†è§†é¢‘è½¬æ¢ä¸ºå›¾æ–‡å¹¶èŒ‚çš„æ–‡ç« </p>
        </div>

        <div class="main-content">
            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="input-section">
                <h2 style="margin-bottom: 20px; color: #333;">ğŸ“ å¼€å§‹åˆ›ä½œ</h2>
                
                <div class="form-group">
                    <label for="video-url">ğŸ¥ YouTubeè§†é¢‘é“¾æ¥</label>
                    <input type="url" id="video-url" class="form-control" 
                           placeholder="è¯·è¾“å…¥YouTubeè§†é¢‘é“¾æ¥ï¼Œä¾‹å¦‚ï¼šhttps://www.youtube.com/watch?v=...">
                </div>

                <div class="form-group">
                    <label for="language">ğŸŒ å­—å¹•è¯­è¨€</label>
                    <select id="language" class="form-control">
                        {% for code, name in languages.items() %}
                        <option value="{{ code }}" {% if code == 'en' %}selected{% endif %}>{{ name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="image-prompt">ğŸ¨ é…å›¾æè¿° (å¯é€‰)</label>
                    <input type="text" id="image-prompt" class="form-control" 
                           placeholder="æè¿°ä½ æƒ³è¦çš„é…å›¾é£æ ¼ï¼Œä¾‹å¦‚ï¼šç°ä»£ç§‘æŠ€é£æ ¼ã€æ¸©é¦¨å®¶åº­åœºæ™¯ç­‰">
                </div>

                <button id="generate-btn" class="btn">ğŸš€ å¼€å§‹ç”Ÿæˆ</button>
                
                <!-- Demoæµ‹è¯•æŒ‰é’® -->
                <div style="margin-top: 15px; padding: 15px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #28a745;">
                    <h4 style="margin-bottom: 10px; color: #155724;">ğŸ§ª Difyå·¥ä½œæµæµ‹è¯• (ç»•è¿‡YouTubeé™åˆ¶)</h4>
                    <p style="font-size: 14px; color: #155724; margin-bottom: 10px;">
                        <strong>çœŸå®Difyå·¥ä½œæµè°ƒç”¨æµ‹è¯•</strong> - ä½¿ç”¨test_document.txtæ–‡ä»¶ç›´æ¥è°ƒç”¨Dify APIï¼ŒéªŒè¯å·¥ä½œæµå®Œæ•´æ€§
                    </p>
                    <p style="font-size: 12px; color: #0d5a0f; margin-bottom: 15px;">
                        âš ï¸ æ³¨æ„ï¼šè¿™ä¸ªæŒ‰é’®ä¼šè°ƒç”¨çœŸå®çš„Difyå·¥ä½œæµï¼Œå¯èƒ½éœ€è¦1-2åˆ†é’Ÿå¤„ç†æ—¶é—´
                    </p>
                    <button id="demo-test-btn" class="btn" style="background: #28a745; padding: 12px 25px; font-size: 16px;">
                        ğŸ¤– æµ‹è¯•Difyå·¥ä½œæµ
                    </button>
                </div>
            </div>

            <!-- è¿›åº¦åŒºåŸŸ -->
            <div id="progress-section" class="progress-section">
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill"></div>
                </div>
                <div id="progress-text" class="progress-text">å‡†å¤‡ä¸­...</div>
            </div>

            <!-- ç»“æœåŒºåŸŸ -->
            <div id="result-section" class="result-section">
                <h2 class="result-title">âœ¨ ç”Ÿæˆç»“æœ</h2>
                
                <!-- æ ¼å¼é€‰æ‹©å™¨ -->
                <div class="format-selector">
                    <button class="format-btn active" data-format="rich">ğŸ“ å¯Œæ–‡æœ¬</button>
                    <button class="format-btn" data-format="html">ğŸŒ HTML</button>
                    <button class="format-btn" data-format="markdown">ğŸ“‹ Markdown</button>
                    <button class="format-btn" data-format="plain">ğŸ“„ çº¯æ–‡æœ¬</button>
                </div>
                
                <div id="result-content" class="result-content rich-content"></div>
                <div id="chart-container" class="chart-container" style="display: none;">
                    <div class="chart-title">ğŸ“Š æ•°æ®å¯è§†åŒ–</div>
                    <canvas id="data-chart"></canvas>
                </div>
                <div id="image-gallery" class="image-gallery"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button id="copy-article-btn" class="btn">ğŸ“ å¤åˆ¶æ–‡ç« </button>
                    <button id="export-html-btn" class="btn">ğŸ’¾ å¯¼å‡ºHTML</button>
                    <button id="generate-chart-btn" class="btn">ğŸ“Š ç”Ÿæˆå›¾è¡¨</button>
                </div>
            </div>

            <!-- åŠŸèƒ½ç‰¹è‰² -->
            <div class="features">
                <div class="feature-card">
                    <div class="feature-icon">ğŸ¥</div>
                    <div class="feature-title">è§†é¢‘å†…å®¹æå–</div>
                    <div class="feature-desc">è‡ªåŠ¨ä¸‹è½½YouTubeè§†é¢‘å­—å¹•ï¼Œæ”¯æŒå¤šç§è¯­è¨€</div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">ğŸ¤–</div>
                    <div class="feature-title">AIæ™ºèƒ½ç”Ÿæˆ</div>
                    <div class="feature-desc">é€šè¿‡Difyå·¥ä½œæµç”Ÿæˆé«˜è´¨é‡æ–‡ç« å†…å®¹</div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">ğŸ¨</div>
                    <div class="feature-title">æ™ºèƒ½é…å›¾</div>
                    <div class="feature-desc">åŸºäºæ–‡ç« ä¸»é¢˜è‡ªåŠ¨ç”Ÿæˆç›¸å…³é…å›¾</div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">ğŸ“</div>
                    <div class="feature-title">å›¾æ–‡ç»“åˆ</div>
                    <div class="feature-desc">æ™ºèƒ½æ’ç‰ˆï¼Œç”Ÿæˆå›¾æ–‡å¹¶èŒ‚çš„æœ€ç»ˆæ–‡ç« </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è·å–DOMå…ƒç´ 
        const videoUrlInput = document.getElementById('video-url');
        const languageSelect = document.getElementById('language');
        const imagePromptInput = document.getElementById('image-prompt');
        const generateBtn = document.getElementById('generate-btn');
        // const testBtn = document.getElementById('test-btn'); // å·²éšè—æµ‹è¯•æŒ‰é’®
        const progressSection = document.getElementById('progress-section');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');
        const resultSection = document.getElementById('result-section');
        const resultContent = document.getElementById('result-content');
        const imageGallery = document.getElementById('image-gallery');
        const copyArticleBtn = document.getElementById('copy-article-btn'); // æ–°å¢å¤åˆ¶æŒ‰é’®
        const formatSelector = document.querySelector('.format-selector');
        const formatButtons = formatSelector.querySelectorAll('.format-btn');
        const resultContentElement = document.getElementById('result-content');
        const chartContainer = document.getElementById('chart-container');
        const dataChartCanvas = document.getElementById('data-chart');
        const generateChartBtn = document.getElementById('generate-chart-btn');
        const exportHtmlBtn = document.getElementById('export-html-btn');
        
        // DemoæŒ‰é’®
        const demoTestBtn = document.getElementById('demo-test-btn');

        // å…¨å±€å˜é‡å­˜å‚¨åŸå§‹æ•°æ®
        let originalContentData = {
            html: '',
            markdown: '',
            plainText: ''
        };

        // æ ¼å¼é€‰æ‹©å™¨ç‚¹å‡»äº‹ä»¶
        formatSelector.addEventListener('click', (event) => {
            const target = event.target;
            if (target.classList.contains('format-btn')) {
                // ç§»é™¤æ‰€æœ‰activeçŠ¶æ€
                formatButtons.forEach(btn => btn.classList.remove('active'));
                // æ·»åŠ activeçŠ¶æ€åˆ°å½“å‰æŒ‰é’®
                target.classList.add('active');
                
                // æ‰§è¡Œæ ¼å¼åˆ‡æ¢
                const format = target.dataset.format;
                console.log('ğŸ”„ åˆ‡æ¢åˆ°æ ¼å¼:', format);
                updateResultContentFormat(format);
            }
        });

        // æ›´æ–°ç»“æœå†…å®¹æ ¼å¼ - å®Œå…¨é‡å†™
        function updateResultContentFormat(format) {
            console.log('ğŸ“ æ ¼å¼åˆ‡æ¢åˆ°:', format);
            
            if (!originalContentData.html) {
                console.warn('âš ï¸ æ²¡æœ‰åŸå§‹æ•°æ®ï¼Œæ— æ³•åˆ‡æ¢æ ¼å¼');
                return;
            }
            
            const container = resultContentElement;
            
            switch (format) {
                case 'rich':
                    // å¯Œæ–‡æœ¬æ ¼å¼ - æ˜¾ç¤ºæ¸²æŸ“åçš„HTML
                    container.className = 'result-content rich-content';
                    container.innerHTML = originalContentData.html;
                    
                    // é‡æ–°è¿è¡Œä»£ç é«˜äº®å’ŒMathJax
                    if (typeof Prism !== 'undefined') {
                        Prism.highlightAll();
                    }
                    if (typeof MathJax !== 'undefined') {
                        MathJax.typesetPromise([container]).catch(console.error);
                    }
                    break;
                    
                case 'html':
                    // HTMLæ ¼å¼ - æ˜¾ç¤ºæºä»£ç 
                    container.className = 'result-content';
                    const escapedHtml = originalContentData.html
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#39;');
                    
                    container.innerHTML = `<pre><code class="language-html">${escapedHtml}</code></pre>`;
                    
                    // ä»£ç é«˜äº®
                    if (typeof Prism !== 'undefined') {
                        Prism.highlightAll();
                    }
                    break;
                    
                case 'markdown':
                    // Markdownæ ¼å¼ - æ˜¾ç¤ºmarkdownæºç 
                    container.className = 'result-content';
                    const markdownText = originalContentData.markdown || convertHtmlToMarkdown(originalContentData.html);
                    
                    container.innerHTML = `<pre><code class="language-markdown">${markdownText}</code></pre>`;
                    
                    // ä»£ç é«˜äº®
                    if (typeof Prism !== 'undefined') {
                        Prism.highlightAll();
                    }
                    break;
                    
                case 'plain':
                    // çº¯æ–‡æœ¬æ ¼å¼ - åªæ˜¾ç¤ºæ–‡æœ¬å†…å®¹
                    container.className = 'result-content';
                    const plainText = originalContentData.plainText || extractPlainText(originalContentData.html);
                    
                    container.innerHTML = `<pre style="white-space: pre-wrap; font-family: inherit; background: #f8f9fa; padding: 20px; border-radius: 8px; line-height: 1.6; color: #333;">${plainText}</pre>`;
                    break;
                    
                default:
                    console.warn('âš ï¸ æœªçŸ¥æ ¼å¼:', format);
                    break;
            }
            
            console.log('âœ… æ ¼å¼åˆ‡æ¢å®Œæˆ:', format);
        }

        // å°†HTMLè½¬æ¢ä¸ºMarkdown - æ”¹è¿›ç‰ˆ
        function convertHtmlToMarkdown(html) {
            let markdown = html;
            
            // è½¬æ¢æ ‡é¢˜
            markdown = markdown.replace(/<h1[^>]*>(.*?)<\/h1>/gi, '# $1\n\n');
            markdown = markdown.replace(/<h2[^>]*>(.*?)<\/h2>/gi, '## $1\n\n');
            markdown = markdown.replace(/<h3[^>]*>(.*?)<\/h3>/gi, '### $1\n\n');
            markdown = markdown.replace(/<h4[^>]*>(.*?)<\/h4>/gi, '#### $1\n\n');
            markdown = markdown.replace(/<h5[^>]*>(.*?)<\/h5>/gi, '##### $1\n\n');
            markdown = markdown.replace(/<h6[^>]*>(.*?)<\/h6>/gi, '###### $1\n\n');
            
            // è½¬æ¢æ®µè½
            markdown = markdown.replace(/<p[^>]*>(.*?)<\/p>/gi, '$1\n\n');
            
            // è½¬æ¢ç²—ä½“å’Œæ–œä½“
            markdown = markdown.replace(/<strong[^>]*>(.*?)<\/strong>/gi, '**$1**');
            markdown = markdown.replace(/<b[^>]*>(.*?)<\/b>/gi, '**$1**');
            markdown = markdown.replace(/<em[^>]*>(.*?)<\/em>/gi, '*$1*');
            markdown = markdown.replace(/<i[^>]*>(.*?)<\/i>/gi, '*$1*');
            
            // è½¬æ¢é“¾æ¥
            markdown = markdown.replace(/<a[^>]*href="([^"]*)"[^>]*>(.*?)<\/a>/gi, '[$2]($1)');
            
            // è½¬æ¢å›¾ç‰‡
            markdown = markdown.replace(/<img[^>]*src="([^"]*)"[^>]*alt="([^"]*)"[^>]*\/?>/gi, '![$2]($1)');
            
            // è½¬æ¢åˆ—è¡¨
            markdown = markdown.replace(/<ul[^>]*>(.*?)<\/ul>/gis, (match, content) => {
                return content.replace(/<li[^>]*>(.*?)<\/li>/gi, '- $1\n') + '\n';
            });
            
            markdown = markdown.replace(/<ol[^>]*>(.*?)<\/ol>/gis, (match, content) => {
                let counter = 1;
                return content.replace(/<li[^>]*>(.*?)<\/li>/gi, () => `${counter++}. $1\n`) + '\n';
            });
            
            // è½¬æ¢ä»£ç å—
            markdown = markdown.replace(/<pre[^>]*><code[^>]*>(.*?)<\/code><\/pre>/gis, '```\n$1\n```\n\n');
            markdown = markdown.replace(/<code[^>]*>(.*?)<\/code>/gi, '`$1`');
            
            // è½¬æ¢å¼•ç”¨
            markdown = markdown.replace(/<blockquote[^>]*>(.*?)<\/blockquote>/gis, '> $1\n\n');
            
            // è½¬æ¢æ°´å¹³çº¿
            markdown = markdown.replace(/<hr[^>]*\/?>/gi, '---\n\n');
            
            // è½¬æ¢æ¢è¡Œ
            markdown = markdown.replace(/<br[^>]*\/?>/gi, '\n');
            
            // æ¸…ç†HTMLæ ‡ç­¾
            markdown = markdown.replace(/<[^>]*>/g, '');
            
            // æ¸…ç†å¤šä½™çš„ç©ºè¡Œ
            markdown = markdown.replace(/\n\s*\n\s*\n/g, '\n\n');
            
            // æ¸…ç†HTMLå®ä½“
            markdown = markdown.replace(/&nbsp;/g, ' ');
            markdown = markdown.replace(/&amp;/g, '&');
            markdown = markdown.replace(/&lt;/g, '<');
            markdown = markdown.replace(/&gt;/g, '>');
            markdown = markdown.replace(/&quot;/g, '"');
            markdown = markdown.replace(/&#39;/g, "'");
            
            return markdown.trim();
        }

        // æå–çº¯æ–‡æœ¬å†…å®¹
        function extractPlainText(html) {
            // åˆ›å»ºä¸´æ—¶DOMå…ƒç´ 
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            // æå–çº¯æ–‡æœ¬
            let plainText = tempDiv.textContent || tempDiv.innerText || '';
            
            // æ¸…ç†å¤šä½™çš„ç©ºç™½
            plainText = plainText.replace(/\s+/g, ' ').trim();
            
            // æŒ‰å¥å­åˆ†è¡Œï¼Œæ”¹å–„å¯è¯»æ€§
            plainText = plainText.replace(/\. /g, '.\n');
            plainText = plainText.replace(/\? /g, '?\n');
            plainText = plainText.replace(/! /g, '!\n');
            
            return plainText;
        }

        // DemoæŒ‰é’®äº‹ä»¶å¤„ç†
        async function handleDemo() {
            startProcessing();
            
            try {
                updateProgress(30, 'ç”ŸæˆDifyå·¥ä½œæµç¤ºä¾‹...');
                
                const response = await fetch('/api/demo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        language: languageSelect.value,
                        picture_style: imagePromptInput.value || 'modern professional style'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Demoè¯·æ±‚å¤±è´¥: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    updateProgress(100, 'ç¤ºä¾‹ç”Ÿæˆå®Œæˆï¼');
                    showResult(result);
                    showAlert('Difyå·¥ä½œæµç¤ºä¾‹ç”ŸæˆæˆåŠŸï¼ç°åœ¨å¯ä»¥æµ‹è¯•æ ¼å¼åˆ‡æ¢åŠŸèƒ½ã€‚', 'success');
                } else {
                    throw new Error(result.message || 'Demoç”Ÿæˆå¤±è´¥');
                }
            } catch (error) {
                console.error('Demoç”Ÿæˆå¤±è´¥:', error);
                showAlert('Demoç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
            } finally {
                stopProcessing();
            }
        }

        // DemoæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        demoTestBtn.addEventListener('click', handleDemo);

        // ç”ŸæˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        generateBtn.addEventListener('click', async () => {
            const videoUrl = videoUrlInput.value.trim();
            const language = languageSelect.value;
            const imagePrompt = imagePromptInput.value.trim();

            if (!videoUrl) {
                showAlert('è¯·è¾“å…¥YouTubeè§†é¢‘é“¾æ¥', 'error');
                return;
            }

            if (!isValidYouTubeUrl(videoUrl)) {
                showAlert('è¯·è¾“å…¥æœ‰æ•ˆçš„YouTubeè§†é¢‘é“¾æ¥', 'error');
                return;
            }

            // å¼€å§‹å¤„ç†
            startProcessing();

            try {
                // å¤„ç†è§†é¢‘
                const result = await processVideo(videoUrl, language, imagePrompt);
                
                if (result.success) {
                    // å¦‚æœæœ‰é…å›¾æè¿°ï¼Œç”Ÿæˆé…å›¾
                    if (imagePrompt) {
                        updateProgress(80, 'ç”Ÿæˆé…å›¾ä¸­...');
                        await generateImages(imagePrompt);
                    }
                    
                    // æ˜¾ç¤ºç»“æœ
                    showResult(result);
                    showAlert('æ–‡ç« ç”ŸæˆæˆåŠŸï¼', 'success');
                } else {
                    throw new Error(result.message || 'å¤„ç†å¤±è´¥');
                }
            } catch (error) {
                console.error('å¤„ç†å¤±è´¥:', error);
                showAlert('å¤„ç†å¤±è´¥: ' + error.message, 'error');
            } finally {
                stopProcessing();
            }
        });

        // å¤åˆ¶æ–‡ç« æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        copyArticleBtn.addEventListener('click', () => {
            try {
                // è·å–æ–‡ç« å†…å®¹
                const titleElement = resultContentElement.querySelector('h3');
                const contentElement = resultContentElement.querySelector('p');
                const title = titleElement ? titleElement.textContent : '';
                const content = contentElement ? contentElement.textContent : '';
                
                // è·å–å›¾ç‰‡ä¿¡æ¯
                const imageItems = imageGallery.querySelectorAll('.image-item');
                let imagesText = '';
                
                if (imageItems.length > 0) {
                    imagesText = '\n\nğŸ“¸ é…å›¾ä¿¡æ¯:\n';
                    imageItems.forEach((item, index) => {
                        const img = item.querySelector('img');
                        const desc = item.querySelector('p');
                        if (img && desc) {
                            imagesText += `${index + 1}. ${desc.textContent}\n   å›¾ç‰‡é“¾æ¥: ${img.src}\n\n`;
                        }
                    });
                }
                
                // ç»„åˆå®Œæ•´æ–‡ç« å†…å®¹
                const fullArticle = `${title}\n\n${content}${imagesText}`;
                
                // å¤åˆ¶åˆ°å‰ªè´´æ¿
                navigator.clipboard.writeText(fullArticle).then(() => {
                    showAlert('æ–‡ç« å†…å®¹ï¼ˆåŒ…å«å›¾ç‰‡ä¿¡æ¯ï¼‰å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    // é™çº§æ–¹æ¡ˆï¼šåˆ›å»ºä¸´æ—¶æ–‡æœ¬åŒºåŸŸ
                    const textArea = document.createElement('textarea');
                    textArea.value = fullArticle;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showAlert('æ–‡ç« å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼', 'success');
                });
                
            } catch (error) {
                console.error('å¤åˆ¶æ“ä½œå¤±è´¥:', error);
                showAlert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            }
        });

        // å¯¼å‡ºHTMLæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        exportHtmlBtn.addEventListener('click', () => {
            const htmlContent = resultContentElement.innerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'article.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showAlert('æ–‡ç« å·²å¯¼å‡ºä¸º article.html', 'success');
        });

        // ç”Ÿæˆå›¾è¡¨æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        generateChartBtn.addEventListener('click', async () => {
            const data = JSON.parse(resultContentElement.dataset.chartData || '{}');
            if (Object.keys(data).length === 0) {
                showAlert('æ²¡æœ‰å¯ç”¨çš„å›¾è¡¨æ•°æ®', 'error');
                return;
            }

            updateProgress(80, 'ç”Ÿæˆå›¾è¡¨ä¸­...');
            try {
                const chartData = await generateChart(data);
                if (chartData.success) {
                    chartContainer.style.display = 'block';
                    const ctx = dataChartCanvas.getContext('2d');
                    new Chart(ctx, {
                        type: 'bar', // ç¤ºä¾‹ç±»å‹ï¼Œå¯æ ¹æ®éœ€è¦æ›´æ”¹
                        data: chartData.data,
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: chartData.title || 'æ•°æ®å¯è§†åŒ–å›¾è¡¨'
                                },
                                legend: {
                                    position: 'top',
                                }
                            }
                        }
                    });
                    showAlert('å›¾è¡¨ç”ŸæˆæˆåŠŸï¼', 'success');
                } else {
                    throw new Error(chartData.message || 'å›¾è¡¨ç”Ÿæˆå¤±è´¥');
                }
            } catch (error) {
                console.error('å›¾è¡¨ç”Ÿæˆå¤±è´¥:', error);
                showAlert('å›¾è¡¨ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
            } finally {
                updateProgress(0, 'å‡†å¤‡ä¸­...');
            }
        });

        // å¼€å§‹å¤„ç†
        function startProcessing() {
            generateBtn.disabled = true;
            generateBtn.textContent = 'å¤„ç†ä¸­...';
            progressSection.style.display = 'block';
            resultSection.style.display = 'none';
            
            // æ¨¡æ‹Ÿè¿›åº¦
            updateProgress(20, 'è§£æè§†é¢‘ä¿¡æ¯...');
            setTimeout(() => updateProgress(40, 'æå–å­—å¹•å†…å®¹...'), 1000);
            setTimeout(() => updateProgress(60, 'AIç”Ÿæˆæ–‡ç« ...'), 2000);
        }

        // åœæ­¢å¤„ç†
        function stopProcessing() {
            generateBtn.disabled = false;
            generateBtn.textContent = 'ğŸš€ å¼€å§‹ç”Ÿæˆ';
            progressSection.style.display = 'none';
            updateProgress(0, 'å‡†å¤‡ä¸­...');
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(percent, text) {
            progressFill.style.width = percent + '%';
            progressText.textContent = text;
        }

        // å¤„ç†è§†é¢‘
        async function processVideo(videoUrl, language, pictureStyle) {
            try {
                console.log('å‘é€è¯·æ±‚åˆ°:', '/api/process-video');
                console.log('è¯·æ±‚æ•°æ®:', { video_url: videoUrl, language: language, picture_style: pictureStyle });
                
                const response = await fetch('/api/process-video', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        video_url: videoUrl,
                        language: language,
                        picture_style: pictureStyle  // ä¼ é€’é…å›¾æè¿°
                    })
                });

                console.log('å“åº”çŠ¶æ€:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('APIé”™è¯¯å“åº”:', errorText);
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                console.log('APIå“åº”:', result);
                return result;
                
            } catch (error) {
                console.error('ç½‘ç»œè¯·æ±‚è¯¦ç»†é”™è¯¯:', error);
                throw error;
            }
        }

        // ç”Ÿæˆé…å›¾
        async function generateImages(prompt) {
            try {
                const response = await fetch('/api/generate-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: prompt
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('é…å›¾ç”Ÿæˆç»“æœ:', result);
                }
            } catch (error) {
                console.error('é…å›¾ç”Ÿæˆå¤±è´¥:', error);
            }
        }

        // ç”Ÿæˆå›¾è¡¨ (ç¤ºä¾‹ï¼Œå®é™…éœ€è¦åç«¯æä¾›æ•°æ®)
        async function generateChart(data) {
            // æ¨¡æ‹Ÿç”Ÿæˆå›¾è¡¨æ•°æ®
            const chartData = {
                labels: Object.keys(data),
                datasets: [{
                    label: 'æ•°æ®',
                    data: Object.values(data),
                    backgroundColor: 'rgba(102, 126, 234, 0.6)',
                    borderColor: 'rgba(102, 126, 234, 1)',
                    borderWidth: 1
                }]
            };
            const chartTitle = 'æ•°æ®å¯è§†åŒ–å›¾è¡¨';
            return { success: true, data: chartData, title: chartTitle };
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult(apiResponse) {
            console.log('æ˜¾ç¤ºç»“æœï¼ŒAPIå“åº”:', apiResponse);
            
            // æ­£ç¡®è®¿é—®æ•°æ®ç»“æ„
            const data = apiResponse.data || apiResponse;
            
            // å®‰å…¨åœ°è·å–æ•°æ®ï¼Œæä¾›é»˜è®¤å€¼
            const title = data.title || 'æœªçŸ¥æ ‡é¢˜';
            const content = data.content || 'å†…å®¹ç”Ÿæˆå¤±è´¥';
            const videoInfo = data.video_info || {};
            const images = data.images || [];
            
            console.log('åŸå§‹å†…å®¹:', content);
            console.log('å†…å®¹é•¿åº¦:', content.length);
            
            // æ™ºèƒ½æ ¼å¼åŒ–å†…å®¹
            let processedContent = smartFormatContent(content);
            
            // æ„å»ºä¸»è¦å†…å®¹åŒºåŸŸ
            const mainContentHtml = `
                <div class="rich-content">
                    <h1>${title}</h1>
                    <div style="margin-top: 20px;">${processedContent}</div>
                </div>
            `;
            
            // æ„å»ºå®Œæ•´ç»“æœå†…å®¹
            let resultHtml = mainContentHtml;
            
            // æ·»åŠ è§†é¢‘ä¿¡æ¯
            resultHtml += `
                <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                    <h3>ğŸ“¹ è§†é¢‘ä¿¡æ¯</h3>
                    <p><strong>é“¾æ¥:</strong> <a href="${videoInfo.url || '#'}" target="_blank">${videoInfo.url || 'æœªçŸ¥'}</a></p>
                    <p><strong>è¯­è¨€:</strong> ${videoInfo.language || 'æœªçŸ¥'}</p>
                    <p><strong>é…å›¾é£æ ¼:</strong> ${videoInfo.picture_style || 'æœªè®¾ç½®'}</p>
                    <p><strong>æ—¶é•¿:</strong> ${videoInfo.duration || 'æœªçŸ¥'}</p>
                </div>
            `;
            
            // æ·»åŠ å¤„ç†ä¿¡æ¯
            if (apiResponse.message) {
                resultHtml += `
                    <div style="margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <h4>â„¹ï¸ å¤„ç†ä¿¡æ¯</h4>
                        <p>${apiResponse.message}</p>
                    </div>
                `;
            }
            
            // æ·»åŠ è°ƒè¯•ä¿¡æ¯
            resultHtml += `
                <details style="margin-top: 20px;">
                    <summary style="cursor: pointer; font-weight: 600; color: #667eea;">ğŸ” è°ƒè¯•ä¿¡æ¯ (ç‚¹å‡»å±•å¼€)</summary>
                    <pre style="background: #f5f5f5; padding: 15px; border-radius: 5px; font-size: 12px; max-height: 300px; overflow-y: auto; margin-top: 10px;">${JSON.stringify(apiResponse, null, 2)}</pre>
                </details>
            `;
            
            // ğŸ”¥ å­˜å‚¨åŸå§‹æ•°æ® - è¿™æ˜¯å…³é”®ï¼
            originalContentData.html = resultHtml;
            originalContentData.markdown = convertHtmlToMarkdown(mainContentHtml);
            originalContentData.plainText = extractPlainText(mainContentHtml);
            
            console.log('ğŸ’¾ åŸå§‹æ•°æ®å·²å­˜å‚¨:', {
                htmlLength: originalContentData.html.length,
                markdownLength: originalContentData.markdown.length,
                plainTextLength: originalContentData.plainText.length
            });
            
            // æ˜¾ç¤ºå†…å®¹
            resultContentElement.innerHTML = resultHtml;
            
            // é‡ç½®æ ¼å¼é€‰æ‹©å™¨åˆ°å¯Œæ–‡æœ¬
            formatButtons.forEach(btn => btn.classList.remove('active'));
            const richBtn = document.querySelector('.format-btn[data-format="rich"]');
            if (richBtn) richBtn.classList.add('active');
            
            // å­˜å‚¨å›¾è¡¨æ•°æ®
            resultContentElement.dataset.chartData = JSON.stringify(data.chart_data || {});
            
            // é‡æ–°è¿è¡Œä»£ç é«˜äº®å’ŒMathJax
            if (typeof Prism !== 'undefined') {
                Prism.highlightAll();
            }
            if (typeof MathJax !== 'undefined') {
                MathJax.typesetPromise([resultContentElement]).then(() => {
                    console.log('MathJaxæ¸²æŸ“å®Œæˆ');
                }).catch((err) => console.log('MathJaxæ¸²æŸ“å¤±è´¥:', err));
            }

            // æ˜¾ç¤ºé…å›¾
            if (images && images.length > 0) {
                imageGallery.innerHTML = images.map(img => `
                    <div class="image-item">
                        <img src="${img.url || ''}" alt="${img.description || 'é…å›¾'}" onerror="this.style.display='none'">
                        <p>${img.description || 'é…å›¾æè¿°'}</p>
                    </div>
                `).join('');
            } else {
                imageGallery.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— é…å›¾</p>';
            }

            resultSection.style.display = 'block';
            
            console.log('âœ… ç»“æœæ˜¾ç¤ºå®Œæˆï¼Œæ ¼å¼åˆ‡æ¢å·²å‡†å¤‡å°±ç»ª');
        }

        // æ™ºèƒ½æ ¼å¼åŒ–å†…å®¹ - å®Œå…¨é‡å†™
        function smartFormatContent(content) {
            console.log('ğŸ”§ å¼€å§‹markdownè§£æï¼ŒåŸå§‹å†…å®¹:', content);
            
            // å¦‚æœå†…å®¹ä¸ºç©ºæˆ–æ— æ•ˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯
            if (!content || typeof content !== 'string') {
                return '<p style="color: #999; font-style: italic;">å†…å®¹ä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯</p>';
            }

            // é¢„å¤„ç†ï¼šæ¸…ç†å’Œæ ‡å‡†åŒ–å†…å®¹
            let processedContent = content.trim();
            
            // ğŸš€ å¼ºåˆ¶ä½¿ç”¨marked.jsè¿›è¡Œmarkdownæ¸²æŸ“
            try {
                // ç¡®ä¿markedå·²åŠ è½½
                if (typeof marked !== 'undefined') {
                    console.log('âœ… ä½¿ç”¨Marked.jså¼ºåˆ¶æ¸²æŸ“Markdown');
                    
                    // é…ç½®markedé€‰é¡¹ - æ›´å®Œæ•´çš„é…ç½®
                    marked.setOptions({
                        breaks: true,           // æ”¯æŒæ¢è¡Œç¬¦
                        gfm: true,             // GitHubé£æ ¼markdown
                        sanitize: false,       // ä¸è¿‡åº¦æ¸…ç†HTML
                        smartypants: false,    // ä¸è½¬æ¢å¼•å·
                        headerIds: false,      // ä¸ç”Ÿæˆheader id
                        mangle: false,         // ä¸æ··æ·†é“¾æ¥
                        pedantic: false,       // ä¸ä¸¥æ ¼æ¨¡å¼
                        smartLists: true,      // æ™ºèƒ½åˆ—è¡¨
                        xhtml: false          // ä¸ä½¿ç”¨XHTML
                    });
                    
                    // ğŸ”¥ ç›´æ¥å¼ºåˆ¶è§£æmarkdownï¼Œä¸ç®¡æ£€æµ‹ç»“æœ
                    const renderedHtml = marked.parse(processedContent);
                    console.log('ğŸ¯ Markdownæ¸²æŸ“ç»“æœ:', renderedHtml);
                    
                    return renderedHtml;
                    
                } else {
                    console.error('âŒ Marked.jsæœªåŠ è½½ï¼Œä½¿ç”¨å¤‡é€‰æ¸²æŸ“');
                    return renderMarkdownFallback(processedContent);
                }
                
            } catch (error) {
                console.error('âŒ Marked.jsæ¸²æŸ“å¤±è´¥:', error);
                return renderMarkdownFallback(processedContent);
            }
        }
        
        // å¤‡é€‰markdownæ¸²æŸ“å‡½æ•°
        function renderMarkdownFallback(content) {
            console.log('ğŸ”§ ä½¿ç”¨å¤‡é€‰markdownæ¸²æŸ“å™¨');
            
            let html = content;
            
            // å¤„ç†æ¢è¡Œç¬¦
            html = html.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            
            // å¤„ç†æ ‡é¢˜ (# ## ### #### ##### ######)
            html = html.replace(/^######\s+(.+)$/gm, '<h6>$1</h6>');
            html = html.replace(/^#####\s+(.+)$/gm, '<h5>$1</h5>');
            html = html.replace(/^####\s+(.+)$/gm, '<h4>$1</h4>');
            html = html.replace(/^###\s+(.+)$/gm, '<h3>$1</h3>');
            html = html.replace(/^##\s+(.+)$/gm, '<h2>$1</h2>');
            html = html.replace(/^#\s+(.+)$/gm, '<h1>$1</h1>');
            
            // å¤„ç†ç²—ä½“ **text**
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // å¤„ç†æ–œä½“ *text*
            html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            
            // å¤„ç†è¡Œå†…ä»£ç  `code`
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // å¤„ç†ä»£ç å— ```code```
            html = html.replace(/```([^`]*)```/gs, '<pre><code>$1</code></pre>');
            
            // å¤„ç†é“¾æ¥ [text](url)
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            
            // å¤„ç†æ— åºåˆ—è¡¨
            html = html.replace(/^[-*+]\s+(.+)$/gm, '<li>$1</li>');
            
            // å¤„ç†æœ‰åºåˆ—è¡¨
            html = html.replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>');
            
            // åŒ…è£…è¿ç»­çš„liä¸ºul/ol
            html = html.replace(/(<li>.*<\/li>)/s, function(match) {
                return '<ul>' + match + '</ul>';
            });
            
            // å¤„ç†å¼•ç”¨ > text
            html = html.replace(/^>\s*(.+)$/gm, '<blockquote>$1</blockquote>');
            
            // å¤„ç†åˆ†éš”çº¿ ---
            html = html.replace(/^---+$/gm, '<hr>');
            
            // å¤„ç†æ®µè½ - åŒæ¢è¡Œç¬¦åˆ†éš”
            const paragraphs = html.split(/\n\s*\n/);
            html = paragraphs.map(p => {
                p = p.trim();
                if (!p) return '';
                
                // å¦‚æœå·²ç»æ˜¯HTMLæ ‡ç­¾ï¼Œç›´æ¥è¿”å›
                if (/^<(h[1-6]|ul|ol|li|blockquote|pre|hr)/.test(p)) {
                    return p;
                }
                
                // å¦åˆ™åŒ…è£…ä¸ºæ®µè½
                return `<p>${p}</p>`;
            }).filter(p => p).join('\n');
            
            // å¤„ç†å•ä¸ªæ¢è¡Œç¬¦ä¸º<br>
            html = html.replace(/\n/g, '<br>');
            
            console.log('ğŸ¯ å¤‡é€‰æ¸²æŸ“ç»“æœ:', html);
            return html;
        }

        // æ£€æµ‹å†…å®¹æ ¼å¼ç±»å‹
        function detectContentFormat(content) {
            // æ£€æµ‹HTMLæ ‡ç­¾
            if (/<[^>]*>/.test(content) && !content.includes('#') && !content.includes('**')) {
                return 'html';
            }
            
            // æ£€æµ‹Markdownè¯­æ³•ï¼ˆæ›´ä¸¥æ ¼çš„æ£€æµ‹ï¼‰
            const markdownPatterns = [
                /^#{1,6}\s+.+$/m,      // æ ‡é¢˜
                /\*\*[^*]+\*\*/,       // ç²—ä½“
                /\*[^*]+\*/,           // æ–œä½“
                /^\s*[-*+]\s+/m,       // åˆ—è¡¨
                /^\s*\d+\.\s+/m,       // æ•°å­—åˆ—è¡¨
                /```[\s\S]*?```/,      // ä»£ç å—
                /`[^`]+`/,             // è¡Œå†…ä»£ç 
                /\[[^\]]*\]\([^)]*\)/, // é“¾æ¥
                /^\s*>/m,              // å¼•ç”¨
                /#{2,}\s+/,            // ## æ ‡é¢˜
                /\*\*[^*]+\*\*/g       // ç²—ä½“æ–‡æœ¬
            ];
            
            // å¦‚æœåŒ…å«å¤šä¸ªmarkdownç‰¹å¾ï¼Œç¡®å®šä¸ºmarkdown
            const markdownMatches = markdownPatterns.filter(pattern => pattern.test(content));
            if (markdownMatches.length >= 2 || content.includes('# ') || content.includes('## ')) {
                return 'markdown';
            }
            
            // æ£€æµ‹ç»“æ„åŒ–æ–‡æœ¬ï¼ˆåŒ…å«å¸¸è§çš„æ ¼å¼åŒ–æ ‡è®°ï¼‰
            const structuredPatterns = [
                /^[#*]{2,}/m,          // ä»¥##æˆ–**å¼€å¤´
                /\*\*[^*]+\*\*/,       // ç²—ä½“æ ‡è®°
                /##\s+[^#]+/,          // æ ‡é¢˜æ ‡è®°
                /^\s*[-â€¢]\s+/m,        // åˆ—è¡¨é¡¹
                /^\s*\d+\.\s+/m,       // æ•°å­—åˆ—è¡¨
                /Introduction|Step \d+|Conclusion/i // å¸¸è§çš„ç»“æ„åŒ–æ–‡æœ¬æ ‡è®°
            ];
            
            if (structuredPatterns.some(pattern => pattern.test(content))) {
                return 'structured-text';
            }
            
            return 'plain';
        }

        // æ ¼å¼åŒ–ç»“æ„åŒ–æ–‡æœ¬
        function formatStructuredText(content) {
            console.log('æ ¼å¼åŒ–ç»“æ„åŒ–æ–‡æœ¬');
            
            let formatted = content;
            
            // è½¬æ¢æ ‡é¢˜æ ‡è®°
            formatted = formatted.replace(/^## ([^#\n]+)/gm, '<h2>$1</h2>');
            formatted = formatted.replace(/^### ([^#\n]+)/gm, '<h3>$1</h3>');
            formatted = formatted.replace(/^#### ([^#\n]+)/gm, '<h4>$1</h4>');
            formatted = formatted.replace(/^# ([^#\n]+)/gm, '<h1>$1</h1>');
            
            // è½¬æ¢ç²—ä½“
            formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // è½¬æ¢æ–œä½“
            formatted = formatted.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            
            // è½¬æ¢åˆ—è¡¨é¡¹
            formatted = formatted.replace(/^[-â€¢]\s+(.+)$/gm, '<li>$1</li>');
            formatted = formatted.replace(/^(\s*)\d+\.\s+(.+)$/gm, '<li>$2</li>');
            
            // åŒ…è£…è¿ç»­çš„liæ ‡ç­¾ä¸ºul - ä¿®å¤ç‰ˆæœ¬
            const lines = formatted.split('\n');
            let result = [];
            let inList = false;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line.startsWith('<li>')) {
                    if (!inList) {
                        result.push('<ul>');
                        inList = true;
                    }
                    result.push(line);
                } else {
                    if (inList) {
                        result.push('</ul>');
                        inList = false;
                    }
                    if (line) {
                        result.push(line);
                    }
                }
            }
            
            // å¦‚æœæœ€åè¿˜åœ¨åˆ—è¡¨ä¸­ï¼Œå…³é—­åˆ—è¡¨
            if (inList) {
                result.push('</ul>');
            }
            
            formatted = result.join('\n');
            
            // è½¬æ¢æ®µè½ï¼ˆå°†åŒæ¢è¡Œç¬¦è½¬æ¢ä¸ºæ®µè½ï¼‰
            const paragraphs = formatted.split(/\n\s*\n/);
            formatted = paragraphs.map(p => {
                p = p.trim();
                if (!p) return '';
                
                // å¦‚æœå·²ç»æ˜¯HTMLæ ‡ç­¾ï¼Œç›´æ¥è¿”å›
                if (/<[^>]*>/.test(p)) {
                    return p;
                }
                
                // å¦åˆ™åŒ…è£…ä¸ºæ®µè½
                return `<p>${p}</p>`;
            }).filter(p => p).join('\n\n');
            
            // æ¸…ç†å¤šä½™çš„ç©ºè¡Œ
            formatted = formatted.replace(/\n\s*\n\s*\n/g, '\n\n');
            
            console.log('æ ¼å¼åŒ–ç»“æœ:', formatted);
            return formatted;
        }

        // æ ¼å¼åŒ–çº¯æ–‡æœ¬
        function formatPlainText(content) {
            console.log('æ ¼å¼åŒ–çº¯æ–‡æœ¬');
            
            // å°†æ–‡æœ¬åˆ†å‰²ä¸ºæ®µè½
            const paragraphs = content.split(/\n\s*\n/);
            
            return paragraphs.map(p => {
                p = p.trim();
                if (!p) return '';
                
                // è‡ªåŠ¨æ£€æµ‹æ ‡é¢˜ï¼ˆé€šå¸¸æ¯”è¾ƒçŸ­ä¸”ç‹¬ç«‹ä¸€è¡Œï¼‰
                if (p.length < 100 && !p.includes('.') && !p.includes(',')) {
                    return `<h3>${p}</h3>`;
                }
                
                return `<p>${p}</p>`;
            }).filter(p => p).join('\n');
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const mainContent = document.querySelector('.main-content');
            mainContent.insertBefore(alertDiv, mainContent.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // éªŒè¯YouTubeé“¾æ¥
        function isValidYouTubeUrl(url) {
            const youtubeRegex = /^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.be)\/.+/;
            return youtubeRegex.test(url);
        }

        // MathJaxé…ç½®
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            }
        };

        // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥APIçŠ¶æ€
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/api/health');
                const health = await response.json();
                
                if (!health.config_valid) {
                    showAlert('é…ç½®æœªå®Œæˆï¼Œè¯·æ£€æŸ¥config.pyæ–‡ä»¶ä¸­çš„APIå¯†é’¥è®¾ç½®', 'error');
                }
                
                // åˆå§‹åŒ–Markedé…ç½®
                if (typeof marked !== 'undefined') {
                    marked.setOptions({
                        highlight: function(code, lang) {
                            if (typeof Prism !== 'undefined' && Prism.languages[lang]) {
                                return Prism.highlight(code, Prism.languages[lang], lang);
                            }
                            return code;
                        },
                        breaks: true,
                        gfm: true,
                        sanitize: false,
                        smartypants: false
                    });
                    console.log('âœ… Marked.jsé…ç½®å®Œæˆ');
                } else {
                    console.warn('âš ï¸ Marked.jsæœªåŠ è½½');
                }
                
            } catch (error) {
                console.error('å¥åº·æ£€æŸ¥å¤±è´¥:', error);
            }
        });
    </script>
</body>
</html> 